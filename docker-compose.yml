services:
  # docker compose up --force-recreate
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    # https://github.com/heyvaldemar/keycloak-traefik-letsencrypt-docker-compose/blob/main/keycloak-traefik-letsencrypt-docker-compose.yml
    command:
      - --log.level=ERROR
      #      - --accesslog=true
      # *** Remove api.insecure for production ***
      # Use port redirection, e.g. to 8081, to access dashboard
      - --api.insecure
      - --ping=true
      - --ping.entrypoint=ping
      - --entryPoints.ping.address=:8082

      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

      - --certificatesresolvers.hrmresolver.acme.httpchallenge=true
      # *** For testing use caserver; comment for default
      # This will generate STAGING (=invalid) certificates for Wannabe Watercress or similar
      #- --certificatesresolvers.hrmresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory
      - --certificatesresolvers.hrmresolver.acme.email=dieter.menne@menne-biomed.de
      - --certificatesresolvers.hrmresolver.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.hrmresolver.acme.httpchallenge.entryPoint=web
      - --global.checkNewVersion=true
      - --global.sendAnonymousUsage=false
      - --log.filePath=/log/traefik.log
    networks:
      - anomanor-net
    ports:
      - 80:80
      - 443:443
      # The Web UI (enabled by --api.insecure=true)
      - 8080:8080
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "http://localhost:8082/ping",
          "--spider"
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    labels:
      # global redirect to https
      - traefik.enable=true
      - traefik.docker.network=anomanor-net
      - traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)
      - traefik.http.routers.http-catchall.entrypoints=websecure
      - traefik.http.routers.http-catchall.middlewares=redirect-to-https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.headers.customrequestheaders.X-Forwarded-Proto=https

    volumes:
      # To view this file, might require:
      # sudo chown hrmconsensus:hrmconsensus letsencrypt/acme.json
      # see chown_docker_sock.sh
      - ./letsencrypt:/letsencrypt
      - ./log:/log
      - /var/run/docker.sock:/var/run/docker.sock

  # Keycloak
  # https://keycloak.discourse.group/t/keycloak-behind-traefik/1832/3
  keycloak:
    build:
      context: .
      dockerfile: Dockerfile_keycloak
    container_name: keycloak
    depends_on:
      - traefik
    labels:
      - traefik.enable=true
      - traefik.http.routers.keycloak.rule=Host(`${KEYCLOAK_SITE}`)
      - traefik.http.routers.keycloak.service=keycloak
      - traefik.http.routers.keycloak.entrypoints=websecure

      - traefik.http.services.keycloak.loadbalancer.server.port=8080
      - traefik.http.routers.keycloak.tls=true
      - traefik.http.routers.keycloak.tls.certresolver=hrmresolver
      - traefik.http.services.keycloak.loadbalancer.passhostheader=true
      - traefik.http.routers.keycloak.middlewares=compresstraefik
      - traefik.http.middlewares.compresstraefik.compress=true
      - traefik.docker.network=anomanor_net
    restart: unless-stopped
    ports:
      # nc -zv smtp.gmail.com 587
      - 8010:8080
    networks:
      - anomanor-net
    healthcheck:
      test: timeout 10s bash -c ':> /dev/tcp/127.0.0.1/8080' || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    volumes:
      - keycloak:/opt/jboss/keycloak/standalone/data
    environment:
      - KC_LOG_LEVEL=ERROR
      - KC_HOSTNAME_STRICT=false
      - KEYCLOAK_ENABLE_STATISTICS=true
      - KC_PROXY_HEADERS=xforwarded
      - KC_HTTP_ENABLED=true
      - TZ=Europe/Berlin
      - KEYCLOAK_ADMIN=${MASTER_ADMIN_USERNAME:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${MASTER_ADMIN_PASSWORD:-admin}
    command: [ "start", "--optimized", "--verbose" ]

  shinyproxy:
    build:
      context: .
      dockerfile: Dockerfile_shinyproxy
    container_name: shinyproxy
    depends_on:
      - traefik
    restart: unless-stopped
    labels:
      - traefik.http.routers.shinyproxy.rule=Host(`hrmconsensus.org`)
      - traefik.http.routers.shinyproxy.entrypoints=websecure
      - traefik.http.routers.shinyproxy.tls=true
      - traefik.http.routers.shinyproxy.tls.certresolver=hrmresolver

    environment:
      # Defaults only used for compose down
      - KEYCLOAK_IP=${KEYCLOAK_IP:-0.0.0.0}
      - ANOMANOR_DATA=${ANOMANOR_DATA:-/root/anomanor_data/anomanor}
    ports:
      - 8020:8080
    networks:
      - anomanor-net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  portainer:
    image: portainer/portainer-ce
    container_name: portainer
    restart: unless-stopped
    depends_on:
      - traefik
    labels:
      - traefik.http.routers.portainer.rule=Host(`portainer.hrmconsensus.org`)
      - traefik.http.routers.portainer.entrypoints=websecure
      - traefik.http.routers.portainer.tls=true
      - traefik.http.routers.portainer.tls.certresolver=hrmresolver
      - traefik.http.services.portainer.loadbalancer.server.port=9000 # required
    networks:
      - anomanor-net
    ports:
      - 9000:9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer:/data

  sqlpad:
    image: sqlpad/sqlpad:latest
    depends_on:
      - traefik
    restart: unless-stopped
    container_name: sqlpad
    labels:
      - traefik.http.routers.sqlpad.rule=Host(`sqlpad.hrmconsensus.org`)
      - traefik.http.routers.sqlpad.entrypoints=websecure
      - traefik.http.routers.sqlpad.tls.certresolver=hrmresolver
    ports:
      - 3000:3000
    networks:
      - anomanor-net
    environment:
      # Defaults are set to avoid warning on docker compose down
      - SQLPAD_ADMIN=${SQLPAD_ADMIN_USERNAME:-sqlpad_admin}
      - SQLPAD_ADMIN_PASSWORD=${SQLPAD_ADMIN_PASSWORD:-sqlpad_admin_password}
    volumes:
      - sqlpad_data:/var/lib/sqlpad
      # Use/root/anomanor_data/anomanor/db/anomanor.sqlite as Filename/path in sqlpad connection
      - /home/hrmconsensus/anomanor_data/anomanor/db:${ANOMANOR_DATA:-/root/anomanor_data/anomanor}/db

volumes:
  # This volume can be missing after a disk backup of the server is restored.
  # You will see an error message after a rebuild
  # Follow the recommendation to recreate it manually, it will re-connect to the
  # existing files on disk
  anomanor_data_db:
    external: true
  portainer:
  keycloak:
  sqlpad_data:


networks:
  anomanor-net:
    name: anomanor-net
    driver: bridge
